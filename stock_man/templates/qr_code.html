{% extends "nav.html" %}
{% block content %}
{% load static%}

<link rel="stylesheet" href="{% static 'css/all.min.css' %}">
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" href="{% static 'css/styles.css' %}">
<link rel="stylesheet" href="{% static 'css/googleapisfonts.css' %}">
<div class="container-fluid">
    <div class="container my-6" style="background-color: #33475b;">
        <div class="p-2">
          <div class="row">
            <div class="col-12 d-flex text-center h5 text-light">
              Generate QR Code
            </div>
          </div>
        </div>
      </div>
      <div class="container my-6 bg-secondary">
        <div class="p-3">
          <div class="row">
            <form method="post" enctype="multipart/form-data" class="needs-validation" id="qrCodeForm" novalidate>
                {% csrf_token %}
            <div class="input-group mb-2 mr-sm-2">
                <div class="input-group-prepend mr-2">
                    <label class="input-group text-white h5 mt-2" for="qr_id">QR ID</label>
                </div>
                <div class="input-group-prepend mr-2">
                    <input type="number" class="form-control ml-2 border-dark h5" name="qr_id" id="qr_id" required></input>
                </div>
                <div class="input-group-prepend mr-2">
                    <button type="button" id="generate-qr-code-btn" onclick="generate_qr()" name="generate_qr_code"
                    class="btn btn-color h5 btn-outline-success text-white btn-sm ml-4">Generate QR Code</button>
                </div>
               
            </div>
        </form>
    </div>
</div>
</div>
</div>
    <div class="modal fade" id="printModal" tabindex="-1" role="dialog" aria-labelledby="printModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title h5" id="printModalLabel">Print QR Code</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">

                    <div class="form-group h5">
                        <label for="printPosition">Print Position:</label>
                        <input type="number" id="printPosition" min=1 max=18
                            title="Please enter a number between 1 and 18">
                    </div>
                </div>
                <div class="modal-footer h5">
                    <button type="button" class="btn btn-color h5 btn-outline-success text-white" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-color h5 btn-outline-success text-white" id="printBtn" onclick="handlePrint()">Print</button>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    function check_validation(form_id, callback) {
        var form = document.getElementById(form_id);
        event.preventDefault(); // Prevent default form submission behavior

        form.classList.add('was-validated'); // Trigger form validation
        if (form.checkValidity()) {
            // Form is valid, perform your desired action here
            console.log('Form is valid. Performing action...');
            callback(true);
        } else {

            callback(false);
        }

    }
    function generate_qr() {
        check_validation('qrCodeForm', function (isValid) {
            if (isValid) {
                var qr_id = document.getElementById('qr_id').value;
                fetch('/check_qr/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token for Django
                },
                body: JSON.stringify({ qr_id:qr_id })
            })
            .then(response => response.json())
                .then(data => {
                    console.log(data);
                   if (data.success=="QR ID Exists"){
                    console.log("here");
                    $('#printModal').modal('show');
                   }
                   else{
                    alert(data.success);
                   }

                })
                .catch(error => console.log("Error fetching items:", error));
                
            }
        });
    }
    function handlePrint() {
        var position = document.getElementById('printPosition').value;
        var qr_id = document.getElementById('qr_id').value;

        if (position > 18 || position < 1) {
            alert("Kindly enter between 1 to 18 only")
        }
        else {
            
            fetch('/generate_pdf_with_qr_id/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token for Django
                },
                body: JSON.stringify({ qr_id: qr_id, position: position })
            })
            .then(response => response.json())
                .then(data => {
                    console.log(data);
                    $('#printModal').hide();
                    window.open("{% static 'pdfs/' %}" + "QR_Code" + ".pdf");
                    window.location.href = "{% url 'qr_code' %}";

                })
                .catch(error => console.log("Error fetching items:", error));
            


        }
    }

</script>
<!-- <script src="{% static 'js/jquery3.6.min.js' %}"></script> -->
<script src="{% static 'js/bootstrap4.6.bundle.min.js' %}"></script>
<script src="{% static 'js/qrcode.min.js' %}"></script>
<script src="{% static 'js/jspdf.umd.min.js' %}"></script>
<!-- <script src="{% static 'js/jquery-3.5.1.slim.min.js' %}"></script> -->
<script src="{% static 'js/bootstrap.min.js' %}"></script>
<script src="{% static 'js/Chart.min.js' %}"></script>
<!-- <script src="{% static 'js/jquery-3.2.1.slim.min.js' %}"></script> -->
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap4.min.js' %}"></script>

<script src="{% static 'js/jquery111.min.js' %}"></script>

{% endblock %}