{% extends "nav.html" %}
{% block content %}
{% load static%}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
<link rel="stylesheet" type="text/css" href="{% static 'css/dataTables.min.css' %}">

<div class="container my-6" style="background-color: #33475b;">
  <div class="p-2">
    <div class="row">
      <div class="col-12 d-flex text-center h5 text-light">
        Issue and Receive
      </div>
    </div>
  </div>
</div>
<div class="container my-6 border border-dark  bg-secondary w-90 " id="issues-returns">
  <div class="p-3">
    <div class="row ">
      <form method="post" enctype="multipart/form-data" class="needs-validation" id="issues_returns_form" novalidate>
        {% csrf_token %}
        <div class="input-group mb-2 mr-sm-2">
          <div class="input-group-prepend mr-2">
            <label for="from-date" class="input-group text-white h5 mt-2">From </label>
          </div>
          <div class="input-group-prepend mr-2">
            <input type="date" class="form-control ml-2 mr-2 h5 border-dark" id="from-date" name="from-date" value="1970-01-01" 
              required>
          </div>
          <div class="input-group-prepend mr-2">
            <label for="to-date" class="input-group text-white h5 mt-2">To </label>
          </div>
          <div class="input-group-prepend mr-2">
            <input type="date" class="form-control h5 border-dark" id="to-date" name="to-date" required>
          </div>
          <div class="input-group-prepend mr-4">
            <label class="text-white ml-2 mt-2 h5" for="include-issues">Issues</label>
          </div>
          <div class="input-group-prepend ml-2 mt-2">
            <input type="checkbox" class="form-check-input h5 border-dark" id="include-issues" name="include-issues">
          </div>
          <div class="input-group-prepend mr-4">
            <label class="text-white ml-2 h5 mt-2" for="include-returns">Receive</label>
          </div>
          <div class="input-group-prepend ml-2 mt-2">
            <input type="checkbox" class="form-check-input h5 border-dark" id="include-returns" name="include-returns">
          </div>
          <div class="input-group-prepend ml-2 mt-2">
            <label for="category-filter" class="h5 text-white">Category</label>
          </div>
          <div class="input-group-prepend ml-2">
            <select class="form-select border-dark h5" id="category-filter" name="category-filter">
              <!-- Options for category filter will be populated dynamically -->
              <option value="0">Select a category</option>
              {% for key,val in categories.items %}
              <option value="{{key}}">{{ val }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="input-group-prepend ml-2">
            <button type="button" class="btn btn-color h5 btn-outline-success text-white"
              onclick="fetchIssuesReturns()">Search</button>
          </div>

        </div>
      </form>
    </div>
  </div>
</div>
<div class="container-fluid mt-2 " id="search_results" hidden>

  <div class="container my-6" style="background-color: #33475b;">
    <div class="p-2">
      <div class="row">
        <div class="col-12 d-flex text-center h5 text-light">
          Search Results
        </div>
      </div>
    </div>
  </div>
  <div class="container my-6 bg-secondary">
    <div class="p-3">
      <div class="row">
        <table class="table table-striped table-bordered table-hover table-clickable" id="IssueReturnsTable">
          <thead>
            <tr class="h5 text-center">
              <th>Sr.No</th>
              <th>Emp Name</th>
              <th>Emp ID</th>
              <th>Category</th>
              <th>Item Name</th>
              <th>Quantity</th>
              <th>Type</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody class="h5 text-center">

          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<div class="container mt-3 h5" id="download_btn" hidden>
  <div class="row">
    <div class="col-md-12 text-center">
      <h8>Download Report</h8>

      <!-- Download Excel Button -->
      <a class="btn btn-success" onclick="downloadExcel()">
        <i class="fas fa-file-excel"></i>Excel
      </a>

      <!-- Download PDF Button -->
      <a class="btn btn-danger" onclick="downloadPDF()">
        <i class="fas fa-file-pdf"></i>Pdf
      </a>
    </div>
  </div>
  </div>




  <script>
    // Get the current date
const today = new Date();

// Format the date as "YYYY-MM-DD" for the input type="date"
const year = today.getFullYear();
const month = String(today.getMonth() + 1).padStart(2, '0');
const day = String(today.getDate()).padStart(2, '0');
const formattedDate = `${year}-${month}-${day}`;

// Set the value of the input element to today's date
document.getElementById("to-date").value = formattedDate;


    function check_validation(form_id, callback) {
      var form = document.getElementById(form_id);
      event.preventDefault(); // Prevent default form submission behavior

      form.classList.add('was-validated'); // Trigger form validation
      if (form.checkValidity()) {
        // Form is valid, perform your desired action here
        console.log('Form is valid. Performing action...');
        callback(true);
      } else {

        callback(false);
      }

    }
    function fetchIssuesReturns() {
    check_validation('issues_returns_form', function (isValid) {
        if (isValid) {
            var from_date = $('#from-date').val();
            var to_date = $('#to-date').val();
            var category_filter = $('#category-filter').val();
            var include_issues = $('#include-issues').prop('checked') ? 1 : 0;
            var include_returns = $('#include-returns').prop('checked') ? 1 : 0;
            search_results = document.getElementById('search_results');
            search_results.hidden = true;
            download_btn = document.getElementById('download_btn');
            download_btn.hidden = true;
            console.log(category_filter);
            // Send an AJAX request to the server
            fetch('/search_issues_returns/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token for Django
                },
                body: JSON.stringify({
                    from_date: from_date,
                    to_date: to_date,
                    category_filter: parseInt(category_filter),
                    include_issues: include_issues,
                    include_returns: include_returns
                })
            })
            .then(response => response.json())
            .then(data => {
                const table = document.getElementById('IssueReturnsTable').getElementsByTagName('tbody')[0];
                var tbody = document.querySelector("#IssueReturnsTable tbody");
                tbody.innerHTML = "";
                if ('error' in data[0]) {
                    search_results.hidden = false;
                    download_btn.hidden = false;
                    const row = table.insertRow();
                    const cell0 = row.insertCell(0); // Serial Number
                    const cell1 = row.insertCell(1);
                    const cell2 = row.insertCell(2);
                    const cell3 = row.insertCell(3);
                    const cell4 = row.insertCell(4);
                    const cell5 = row.insertCell(5);
                    const cell6 = row.insertCell(6);
                    const cell7 = row.insertCell(7);

                    cell0.innerHTML = ''; // Serial Number
                    cell1.innerHTML = 'No Data'; // Assuming your JSON has 'emp_name' field
                    cell2.innerHTML = 'No Data'; // Assuming your JSON has 'emp_id' field
                    cell3.innerHTML = 'No Data'; // Assuming your JSON has 'category' field
                    cell4.innerHTML = 'No Data'; // Assuming your JSON has 'item_name' field
                    cell5.innerHTML = 'No Data'; // Assuming your JSON has 'qty' field
                    cell6.innerHTML = 'No Data'; // Assuming your JSON has 'type' field
                    cell7.innerHTML = 'No Data'; // Assuming your JSON has 'date' field
                } else {
                    search_results.hidden = false;
                    download_btn.hidden = false;
                    data.forEach((item, index) => {
                        const row = table.insertRow();
                        const cell0 = row.insertCell(0); // Serial Number
                        const cell1 = row.insertCell(1);
                        const cell2 = row.insertCell(2);
                        const cell3 = row.insertCell(3);
                        const cell4 = row.insertCell(4);
                        const cell5 = row.insertCell(5);
                        const cell6 = row.insertCell(6);
                        const cell7 = row.insertCell(7);

                        cell0.innerHTML = index + 1; // Serial Number
                        cell1.innerHTML = item.emp_name; // Assuming your JSON has 'emp_name' field
                        cell2.innerHTML = item.emp_id; // Assuming your JSON has 'emp_id' field
                        cell3.innerHTML = item.category; // Assuming your JSON has 'category' field
                        cell4.innerHTML = item.item_name; // Assuming your JSON has 'item_name' field
                        cell5.innerHTML = item.qty; // Assuming your JSON has 'qty' field
                        cell6.innerHTML = item.type; // Assuming your JSON has 'type' field
                        cell7.innerHTML = item.date; // Assuming your JSON has 'date' field
                    });
                }

                if (!$.fn.DataTable.isDataTable('#IssueReturnsTable')) {
                    $('#IssueReturnsTable').DataTable({
                        lengthMenu: [5, 10, 25, 50], // Display options for number of records per page
                        pageLength: 10, // Default number of records per page
                        ordering: false, // Disable sorting
                        // Add more options as needed
                    });
                    var lbl = document.getElementsByTagName("label");
                    var sel = document.getElementsByTagName("select");
                    var inp = document.getElementsByTagName("input");
                    var anc = document.getElementsByTagName('a');
                    var id_entry = document.getElementById('IssueReturnsTable_info');
                    console.log(id_entry);
                    if (lbl) {
                        console.log(lbl[5].classList.add('text-white', 'h5'));
                        console.log(lbl[6].classList.add('text-white', 'h5'));
                    }
                    if (sel) {
                        console.log(sel[1].classList.add('text-white', 'border-dark', 'bg-secondary', 'h5'));
                    }
                    if (inp) {
                        console.log(inp[6].classList.add('text-white', 'border-dark', 'h5'));
                    }
                    if (id_entry) {
                        console.log(id_entry.classList.add('text-white', 'h5'));
                    }
                }
            })
            .catch(error => console.error('Error:', error));
        }
    });
}

  </script>
  <script>

    function loadItems() {
      var category = document.getElementById("quantityCategory").value;
      console.log(category);
      // Make an AJAX request to fetch the items based on the selected category
      // Pass the selected category as a parameter to the server-side script

      // Example using JavaScript Fetch API
      fetch('/get_items/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}' // Include CSRF token for Django
        },
        body: JSON.stringify({ category: category })
      })
        .then(response => response.json())
        .then(data => {
          // Populate the item dropdown with the fetched items
          var itemDropdown = document.getElementById("quantityItem");
          itemDropdown.innerHTML = "<option value=''>Select an item</option>";
          console.log(data);
          data.forEach(function (item) {
            var option = document.createElement("option");
            option.value = item.item_id;
            option.text = item.item_name;
            itemDropdown.appendChild(option);
          });
        })
        .catch(error => console.log("Error fetching items:", error));
    }
    function downloadPDF() {
      var table = document.getElementById('IssueReturnsTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      var rows = tbody.getElementsByTagName('tr');

      var yourData = [];
      // Extract column headers (from <th> tags)
      var headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
      var headerCells = headerRow.getElementsByTagName('th');
      var headerData = [];

      for (var i = 0; i < headerCells.length; i++) {
        headerData.push(headerCells[i].innerText);
      }

      yourData.push(headerData);
      // Loop through table rows and extract cell values
      for (var i = 0; i < rows.length; i++) {

        var cells = rows[i].getElementsByTagName('td');
        var rowData = [];

        for (var j = 0; j < cells.length; j++) {
          rowData.push(cells[j].innerText);
        }

        yourData.push(rowData);
      }
      fetch('/download_pdf/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ data: yourData ,type:"Issues & Returns"})
      })
        .then(response => response.blob())
        .then(blob => {
          // Create a temporary URL for the blob object
          const url = window.URL.createObjectURL(blob);

          // Create a link element
          const link = document.createElement('a');
          link.href = url;
          link.download = 'inventory_report.pdf';

          // Append the link element to the document body
          document.body.appendChild(link);

          // Trigger the download by programmatically clicking the link
          link.click();

          // Clean up by removing the link element and revoking the temporary URL
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        })
        .catch(error => {
          console.error('Error generating PDF:', error);
        });


    }
    function downloadExcel() {
      var table = document.getElementById('IssueReturnsTable');
      var tbody = table.getElementsByTagName('tbody')[0];
      var rows = tbody.getElementsByTagName('tr');

      var yourData = [];
      // Extract column headers (from <th> tags)
      var headerRow = table.getElementsByTagName('thead')[0].getElementsByTagName('tr')[0];
      var headerCells = headerRow.getElementsByTagName('th');
      var headerData = [];

      for (var i = 0; i < headerCells.length; i++) {
        headerData.push(headerCells[i].innerText);
      }

      yourData.push(headerData);
      // Loop through table rows and extract cell values
      for (var i = 0; i < rows.length; i++) {

        var cells = rows[i].getElementsByTagName('td');
        var rowData = [];

        for (var j = 0; j < cells.length; j++) {
          rowData.push(cells[j].innerText);
        }

        yourData.push(rowData);
      }
      console.log(yourData);
      fetch('/download_excel/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ data: yourData })
      })
        .then(response => {
          if (response.ok) {
            return response.blob();
          } else {
            throw new Error('Error generating Excel file.');
          }
        })
        .then(blob => {
          var url = window.URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url;
          a.download = 'report.xlsx';
          document.body.appendChild(a);
          a.click();
          a.remove();
        });
    }
  </script>
<script src="{% static 'js/dashboard.js' %}"></script>
<script src="{% static 'js/jquery-3.2.1.slim.min.js' %}"></script>
<script src="{% static 'js/popper.min.js' %}"></script>
<script src="{% static 'js/bootstrap4.min.js' %}"></script>
<script src="{% static 'js/dataTables.min.js' %}"></script>
  {% endblock %}